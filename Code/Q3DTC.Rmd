---
title: "Q3_DTC"
author: "KHigashi, ECampbell"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ipumsr)  
library(dplyr)
library(tidyverse)
library(jtools)
library(vtable)
library(car)
library(lubridate)
library(haven)
```

# Read in Data

```{r}

# Read in Industry codes and select industries of interest
Industries <- read_csv('indnames.csv')                            # merge using IND
Industries <- Industries %>%
  rename(IND = ind)     

# Read in State Federal Information Processing Codes.  
state_fips <- read_csv('state-geocodes-v2021.csv') 
# rename(STATEFIP = State '(FIPS)') %>%
#select(STATEFIP, Name)

# read in IPUMS demographic data from JAN 2019 through DEC 2021 & filter for those >= 15 years olds
ddi <- read_ipums_ddi("cps_00016.xml")   
dataQ3 <- read_ipums_micro(ddi) %>% 
  zap_labels() %>%
  filter(AGE >= 15)                       # 41 variables
  #mutate(STATEFIP = as.character(STATEFIP))

cov_ddi <- read_ipums_ddi("cps_00001.xml")   
cov_dataQ3 <- read_ipums_micro(cov_ddi) %>% 
  zap_labels()

```

# Clean and Categorize Raw Data
## Demographics
```{r}

# read in IPUMS Demographic data from JAN 2019 through DEC 2021 & filter for those >= 15 years olds
dem_ddi <- read_ipums_ddi("cps_00016.xml")   
dem_data <- read_ipums_micro(dem_ddi) %>% 
  zap_labels() %>%
  mutate(yr_month = paste(YEAR, MONTH, sep= "-")) %>% 
  filter(AGE >= 15) %>%
  mutate(Married = ifelse(MARST ==1,1,0))%>%
  
  ## Classify/Group Demographics
  mutate(RACE = case_when(
    HISPAN == '0' & RACE == '100' ~ 'White',
    HISPAN == '0' & RACE == '200' ~ 'Black',  
    HISPAN == '0' & RACE == '300' ~ 'AmericanIndian',
    HISPAN == '0' & RACE %in% c('650', '651', '652') ~ 'Asian',
    HISPAN == '0' & !(RACE %in% c('100', '200', '300', '650', '651', '652')) ~ 'MixedRace',
    HISPAN != '0' ~ 'Latino')) %>%
  mutate(AgeGroup = case_when(
    AGE < 20 ~ 'under20',
    AGE >= 20 & AGE < 30 ~ '20to29',
    AGE >= 30 & AGE < 40 ~ '30to39',
    AGE >= 40 & AGE < 50 ~ '40to49',
    AGE >= 50 & AGE < 60 ~ '50to59',
    AGE >= 60 & AGE <= 65 ~ '60to65',
    AGE >= 65 ~ 'RetirementAge')) %>%
  mutate(Regions = case_when(
    REGION == 11 | REGION == 12 ~ 'Northeast',
    REGION == 21 | REGION == 22 ~ 'Midwest',
    REGION == 31 | REGION == 32 |  REGION == 33 ~ 'South',
    REGION == 41 | REGION == 42 ~ 'West',
    REGION == 97 ~ 'Unknown')) %>%
  mutate(METRO = case_when (
    METRO %in% c(0, 4) ~  'Other',
    METRO == 1 ~  'Rural',
    METRO == 2 ~  'CityCenter',
    METRO == 3 ~  'Suburb')) %>%
  mutate(Education = case_when(
    EDUC99 == 00 ~ 'Unknown',
    EDUC99 >= 1 & EDUC99 <=9 ~ 'NoDiploma',
    EDUC99 == 10 ~ 'HighSchoolDiploma',
    EDUC99 == 11 ~ 'SomeCollege',
    EDUC99 >= 12 & EDUC99 <= 14 ~  'AssociateDegree',
    EDUC99 == 15 ~ 'Bachelors',
    EDUC99 == 16 ~ 'Masters',
    EDUC99 > 16 ~ 'PhDProfessional')) %>%
  mutate(LaborForce = case_when(
    LABFORCE == 0  ~ 'Military',
    LABFORCE == 1  ~ '0',
    LABFORCE == 2  ~ '1')) %>%
  mutate(EmploymentStatus = case_when(
    EMPSTAT <= 1 | EMPSTAT >= 30 ~  'Other',
    EMPSTAT >= 10 & EMPSTAT < 20 ~ '1',
    EMPSTAT >= 20 & EMPSTAT < 30 ~ '1')) %>%
  mutate(WorkStatus = case_when(
    WKSTAT %in% c(11, 14, 15) ~ 'FullTime',
    WKSTAT %in% c(12, 20, 21, 22, 40, 41) ~ 'PartTime',
    WKSTAT == 13 ~ 'FullTimeNoWork',
    WKSTAT == 42 ~ 'PartTimeNoWork',
    WKSTAT == 50 ~ 'NoWorkSeekingFullTime',
    WKSTAT == 60 ~ 'NoWorkSeekingPartTime',
    WKSTAT == 99 ~ 'MilitaryNoLaborForce',
  )) %>%
  mutate(FamilyIncome =case_when(                       # 2020 FPL 1 = $12,760, 2 = $17,240, 3 = $21,720. 4 = $26,200 
    FAMINC <= 600 ~ '<$25k_FPL_Familyof4',
    FAMINC > 600 & FAMINC <= 740 ~ '25k-50K',
    FAMINC > 740 & FAMINC <= 830 ~ '50k-75k',
    FAMINC > 830 & FAMINC <= 841~ '75k-100k',
    FAMINC == 842  ~ '100k - 150k',
    FAMINC == 843 ~ '150k+',
    FAMINC == 999 ~ 'NA')) %>% 
  

```

## Covid & Addt Workforce Variables

```{r}

cov_unemp_data <- cov_dataQ3 %>% 
 
  ## create time concat for joins
  mutate(yr_month = paste(YEAR, MONTH, sep= "-")) %>% 

  ## mutate and categorize Covid variables
  mutate(
    covid_work_remote = (case_when(
        COVIDTELEW == 1 ~ FALSE
        COVIDTELEW == 2 ~ TRUE
      ))
  , covid_unable_to_work = (case_when(
    COVIDUNAW == 1 ~ FALSE
    COVIDUNAW == 2 ~ TRUE
  ))
  , covid_pto = (case_when(
    COVIDPAID == 1 ~ FALSE
    COVIDPAID == 2 ~ TRUE
  ))
  , covid_did_not_look = (case_when(
    COVIDLOOK == 1 ~ FALSE
    COVIDLOOK == 2 ~ TRUE
  ))
  , covid_med_care_only = (case_when(
    COVIDMED == 1 ~ FALSE
    COVIDMED == 2 ~ TRUE
  ))
  , same_IND = (case_when(
    IND == INDLY & !is.null(IND) & !is.null(INDLY) ~ TRUE
    is.null(IND) | is.null(INDLY) ~ NULL
    FALSE ~ else-output-value 
  ))
  ) %>% 
  
  ## mutate and categorize unemployment and unemployment reason codes
  mutate(
    unemployment_reason = (case_when(
      WHYUNEMP == 1 ~	'Job loser - on layoff'
      WHYUNEMP == 2	~ 'Other job loser'
      WHYUNEMP == 3	~ 'Temporary job ended'
      WHYUNEMP == 4	~ 'Job leaver'
      WHYUNEMP == 5	~ 'Re-entrant'
      WHYUNEMP == 6	~ 'New entrant'
    ))
  
  , absence_reason = (case_when(
    
      WHYABSNT == 01	~ 'Temp_Layoff'
      WHYABSNT == 02	~ 'Indefinite_Layoff'
      WHYABSNT == 03	~ 'Slack_Business_Conditions'
      WHYABSNT == 04	~ 'Starting_New_Job'
  
      WHYABSNT == 05	~ 'Vacation_Personal'
      WHYABSNT == 06	~ 'Illness_ Medical'
      
      WHYABSNT == 07	~ 'Childcare'
      WHYABSNT == 08	~ 'Family_other'
      
      WHYABSNT == 09	~ 'Parental_leave'
      WHYABSNT == 10	~ 'Labor_dispute'
      
      WHYABSNT == 11	~ 'Weather'
      WHYABSNT == 12	~ 'School'
      WHYABSNT == 13	~ 'Military'
      WHYABSNT == 14	~ 'Does_Not_Work'
    
      WHYABSNT == 15	~ 'Other'
    ))
  
  
  , reason_left_job = (case_when(
    
      UH_WHYLFT_B2 == 01 ~	'Personal_Family'
      UH_WHYLFT_B2 == 02 ~	'Return_to_School'
      
      UH_WHYLFT_B2 == 03 ~	'Health'
      UH_WHYLFT_B2 == 04 ~	'Retirement'
      
      UH_WHYLFT_B2 == 05 ~	'Temporary_Job_Complete'
      UH_WHYLFT_B2 == 06 ~	'Slack_Business_Conditions'
      
      UH_WHYLFT_B2 == 07 ~	'Unsatisfactory_Work'
      UH_WHYLFT_B2 == 08 ~	'Other'
    
    
  ))
  )
  


```

## Join Demographics and Covid/Unemployment DFs
```{r}
DF <- dem_data %>% 
 left_join(cov_unemp_data, by = c("yr_month" = "yr_month", "CPSIDP" = "CPSIDP"))

  ## Join in geographic info
  left_join(state_fips, by = 'STATEFIP') %>% 
  
  mutate(State = Name) %>% 
  select(-REGION, -STATECENSUS, -PERNUM, -SEX, -MARST, - EMPSTAT, -LABFORCE, -DURUNEMP, -DURUNEM2, -WHYABSNT, 
         -WKSTAT, -MULTJOB, - NUMJOB, - UNION, -OTPAY, -ASECFLAG, -SERIAL, -HISPAN, - EDUC99, -Name) %>%  
  ## Join in industry categories
  left_join(Industries, by = 'IND') %>%
  ## Classify industry categories
  filter(indname %in% c('Manufacturing', 'Information', 'Retail Trade', 'Arts, Entertainment, and Recreation, and Accommodation and Food Services',
                        'Educational Services, and Health Care and Social Assistance', 'Transportation and Warehousing, and Utilities' )) %>%
  mutate(indname = case_when(indname == 'Retail Trade' ~ 'retail', indname == 'Manufacturing' ~ 'manufacturing', indname == 'Information' ~ 'information',
                             indname == 'Arts, Entertainment, and Recreation, and Accommodation and Food Services' ~ 'art_leisure_hospitality',
                             indname == 'Educational Services, and Health Care and Social Assistance' ~ 'education_healthcare',
                             indname == 'Transportation and Warehousing, and Utilities' ~ 'transport_warehouse'))

```


